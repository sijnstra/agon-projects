Zilog eZ80 Macro Assembler Version 4.3 (19073001) RELISTED                                      16-Sep-25     22:43:57     page:   1


PC     Object              I  Line    Source 
                           A     1    ; CP/M 2048
                           A     2    ;
                           A     3    ;
                           A     4    ; Converted to Agon native by Shawn Sijnstra <shawn@sijnstra.com>
                           A     5    ; Updated 16-Aug-2025 for terminal mode changes.
                           A     6    ;   Based on 2048 created by Gabriele Cirulli.
                           A     7    ;   Based on the console version for GNU/Linux by Maurits van der Schee
                           A     8    ;   Ported to Z80 and CP/M by Marco Maccaferri <macca@maccasoft.com>
                           A     9    ;   Slight VT100 compatibility changes by acn128 <acn@acn.wtf>
                           A    10    ;
                           A    11    ; Notable changes for reference:
                           A    12    ; required colons on all labels
                           A    13    ; labels are case sensitive
                           A    14    ; code is a reserved word and can't be used as a label
                           A    15    ; numeric evaluations are done differently - check results carefully
                           A    16    ; no dot in front of DB, DW or END
                           A    17    ; assembly source MUST be .asm, can't use e.g. .zsm
                           A    18    ; supports defb as a synonym for db, but NOT defw. Must use dw. defs also missing - use ds.
                           A    19    ; labels can't start with @
                           A    20    ; Can't finish a line with a backslash
                           A    21    ; dollar signs don't work for specifying hex
                           A    22    
                           A    23    
                           A    24    			.ASSUME	ADL = 0
                           A    25    
                           B     0    			INCLUDE	"equs.inc"
                           B     1    ;
                           B     2    ; Title:	Memory Dump - Equs
                           B     3    ; Author:	Dean Belfield
                           B     4    ; Created:	15/11/2022
                           B     5    ; Last Updated:	15/11/2022
                           B     6    ;
                           B     7    ; Modinfo:
                           B     8    				
                           B     9    ;RAM_Top:		EQU		0FF00h
                           B    10    ;Stack_Top:		EQU		00000h	; Stack at top
                           B    11    	
                           B    12    ; For GPIO
                           B    13    ; PA not available on eZ80L92
                           B    14    ;
       00000096            B    15    PA_DR:			EQU		96h
       00000097            B    16    PA_DDR:			EQU		97h
       00000098            B    17    PA_ALT1:		EQU		98h
       00000099            B    18    PA_ALT2:		EQU		99h
       0000009A            B    19    PB_DR:          	EQU		9Ah
       0000009B            B    20    PB_DDR:        	 	EQU		9Bh
       0000009C            B    21    PB_ALT1:        	EQU		9Ch
       0000009D            B    22    PB_ALT2:        	EQU		9Dh
       0000009E            B    23    PC_DR:          	EQU		9Eh
       0000009F            B    24    PC_DDR:         	EQU		9Fh
       000000A0            B    25    PC_ALT1:        	EQU		A0h
       000000A1            B    26    PC_ALT2:        	EQU		A1h
       000000A2            B    27    PD_DR:          	EQU		A2h
       000000A3            B    28    PD_DDR:			EQU		A3h
       000000A4            B    29    PD_ALT1:		EQU		A4h
       000000A5            B    30    PD_ALT2:		EQU		A5h
                           B    31    	
       00000000            B    32    GPIOMODE_OUT:		EQU		0	; Output
       00000001            B    33    GPIOMODE_IN:		EQU		1	; Input
       00000002            B    34    GPIOMODE_DIO:		EQU		2	; Open Drain IO
       00000003            B    35    GPIOMODE_SIO:		EQU		3	; Open Source IO
       00000004            B    36    GPIOMODE_INTD:		EQU		4	; Interrupt, Dual Edge
       00000005            B    37    GPIOMODE_ALTF:		EQU		5;	; Alt Function
       00000006            B    38    GPIOMODE_INTAL:		EQU		6	; Interrupt, Active Low
       00000007            B    39    GPIOMODE_INTAH:		EQU		7	; Interrupt, Active High
       00000008            B    40    GPIOMODE_INTFE:		EQU		8	; Interrupt, Falling Edge
       00000009            B    41    GPIOMODE_INTRE:		EQU		9	; Interrupt, Rising Edge
                           B    42    	
                           B    43    ; For serial.asm
                           B    44    ; 
       016E3600            B    45    BASE_CLOCK		EQU	24000000	; It's actually 48000000 in the Project Settings
                           B    46    
       00000003            B    47    BAUD_500000		EQU	BASE_CLOCK / (16 * 500000)
       00000006            B    48    BAUD_250000		EQU	BASE_CLOCK / (16 * 250000)
       0000000C            B    49    BAUD_125000		EQU	BASE_CLOCK / (16 * 125000)
       0000004E            B    50    BAUD_19200		EQU	BASE_CLOCK / (16 * 19200)	
                           B    51    
                           B    52    ; For interrupts.asm
                           B    53    ;
                           B    54    
                           B    55    ;UARTs
                           B    56    ;
       00000018            B    57    UART0_IVECT		EQU		18h
       0000001A            B    58    UART1_IVECT		EQU		1Ah
                           B    59    
                           B    60    ;Ports
                           B    61    ;
       00000030            B    62    PB0_IVECT   		EQU   	30h	; AGON ITRP Interrupt   (Pin 28/IO17 of the ESP32)
       00000032            B    63    PB1_IVECT  	  	EQU  	32h	; AGON VBLANK Interrupt (Pin 23/IO15 of the ESP32)
       00000034            B    64    PB2_IVECT  	  	EQU   	34h
       00000036            B    65    PB3_IVECT  	  	EQU   	36h
       00000038            B    66    PB4_IVECT    		EQU   	38h
       0000003A            B    67    PB5_IVECT    		EQU   	3Ah
       0000003C            B    68    PB6_IVECT    		EQU   	3Ch
       0000003E            B    69    PB7_IVECT    		EQU   	3Eh
                           B    70                           
       00000040            B    71    PC0_IVECT    		EQU   	40h
       00000042            B    72    PC1_IVECT    		EQU   	42h
       00000044            B    73    PC2_IVECT    		EQU   	44h
       00000046            B    74    PC3_IVECT    		EQU   	46h
       00000048            B    75    PC4_IVECT    		EQU   	48h
       0000004A            B    76    PC5_IVECT    		EQU   	4Ah
       0000004C            B    77    PC6_IVECT    		EQU   	4Ch
       0000004E            B    78    PC7_IVECT    		EQU   	4Eh
                           B    79                           
       00000050            B    80    PD0_IVECT    		EQU   	50h
       00000052            B    81    PD1_IVECT    		EQU   	52h
       00000054            B    82    PD2_IVECT    		EQU   	54h
       00000056            B    83    PD3_IVECT    		EQU   	56h
       00000058            B    84    PD4_IVECT    		EQU   	58h
       0000005A            B    85    PD5_IVECT    		EQU   	5Ah
       0000005C            B    86    PD6_IVECT    		EQU   	5Ch
       0000005E            B    87    PD7_IVECT    		EQU   	5Eh
                           B    88    
                           B    89    ; Originally in main.asm
                           B    90    ;
       0000000D            B    91    CR:			EQU     0DH
       0000000A            B    92    LF:			EQU     0AH
       0000001B            B    93    ESC:			EQU     1BH
                           B     0    			INCLUDE "mos_api.inc"	; In MOS/src
                           B     1    ;
                           B     2    ; Title:	AGON MOS - API for user projects
                           B     3    ; Author:	Dean Belfield
                           B     4    ; Created:	03/08/2022
                           B     5    ; Last Updated:	15/04/2023
                           B     6    ;
                           B     7    ; Modinfo:
                           B     8    ; 05/08/2022:	Added mos_feof
                           B     9    ; 09/08/2022:	Added system variables: cursorX, cursorY
                           B    10    ; 18/08/2022:	Added system variables: scrchar, scrpixel, audioChannel, audioSuccess, vpd_pflags
                           B    11    ; 05/09/2022:	Added mos_ren, vdp_pflag_mode
                           B    12    ; 24/09/2022:	Added mos_getError, mos_mkdir
                           B    13    ; 13/10/2022:	Added mos_oscli
                           B    14    ; 23/02/2023:	Added more sysvars, fixed typo in sysvar_audioSuccess, offsets for sysvar_scrCols, 
                           B    15    ; 04/03/2023:	Added sysvar_scrpixelIndex
                           B    16    ; 08/03/2023:	Renamed sysvar_keycode to sysvar_keyascii, added sysvar_vkeycode
                           B    17    ; 15/03/2023:	Added mos_copy, mos_getrtc, mos_setrtc, rtc, vdp_pflag_rtc
                           B    18    ; 21/03/2023:	Added mos_setintvector, sysvars for keyboard status, vdu codes for vdp
                           B    19    ; 22/03/2023:	The VDP commands are now indexed from 0x80
                           B    20    ; 29/03/2023:	Added mos_uopen, mos_uclose, mos_ugetc, mos_uputc
                           B    21    ; 13/04/2023:	Added FatFS file structures (FFOBJID, FIL, DIR, FILINFO)
                           B    22    ; 15/04/2023:	Added mos_getfil, mos_fread, mos_fwrite and mos_flseek
                           B    23    
                           B    24    ; VDP control (VDU 23, 0, n)
                           B    25    ;
       00000080            B    26    vdp_gp:			EQU 	80h
       00000081            B    27    vdp_keycode:		EQU 	81h
       00000082            B    28    vdp_cursor:		EQU	82h
       00000083            B    29    vdp_scrchar:		EQU	83h
       00000084            B    30    vdp_scrpixel:		EQU	84h
       00000085            B    31    vdp_audio:		EQU	85h
       00000086            B    32    vdp_mode:		EQU	86h
       00000087            B    33    vdp_rtc:		EQU	87h
       00000088            B    34    vdp_keystate:		EQU	88h
       000000C0            B    35    vdp_logicalcoords:	EQU	C0h
       000000FF            B    36    vdp_terminalmode:	EQU	FFh
                           B    37    
                           B    38    ; MOS high level functions
                           B    39    ;
       00000000            B    40    mos_getkey:		EQU	00h
       00000001            B    41    mos_load:		EQU	01h
       00000002            B    42    mos_save:		EQU	02h
       00000003            B    43    mos_cd:			EQU	03h
       00000004            B    44    mos_dir:		EQU	04h
       00000005            B    45    mos_del:		EQU	05h
       00000006            B    46    mos_ren:		EQU	06h
       00000007            B    47    mos_mkdir:		EQU	07h
       00000008            B    48    mos_sysvars:		EQU	08h
       00000009            B    49    mos_editline:		EQU	09h
       0000000A            B    50    mos_fopen:		EQU	0Ah
       0000000B            B    51    mos_fclose:		EQU	0Bh
       0000000C            B    52    mos_fgetc:		EQU	0Ch
       0000000D            B    53    mos_fputc:		EQU	0Dh
       0000000E            B    54    mos_feof:		EQU	0Eh
       0000000F            B    55    mos_getError:		EQU	0Fh
       00000010            B    56    mos_oscli:		EQU	10h
       00000011            B    57    mos_copy:		EQU	11h
       00000012            B    58    mos_getrtc:		EQU	12h
       00000013            B    59    mos_setrtc:		EQU	13h
       00000014            B    60    mos_setintvector:	EQU	14h
       00000015            B    61    mos_uopen:		EQU	15h
       00000016            B    62    mos_uclose:		EQU	16h
       00000017            B    63    mos_ugetc:		EQU	17h
       00000018            B    64    mos_uputc:		EQU 	18h
       00000019            B    65    mos_getfil:		EQU	19h
       0000001A            B    66    mos_fread:		EQU	1Ah
       0000001B            B    67    mos_fwrite:		EQU	1Bh
       0000001C            B    68    mos_flseek:		EQU	1Ch
                           B    69    
                           B    70    ; FatFS file access functions
                           B    71    ;
       00000080            B    72    ffs_fopen:		EQU	80h
       00000081            B    73    ffs_fclose:		EQU	81h
       00000082            B    74    ffs_fread:		EQU	82h
       00000083            B    75    ffs_fwrite:		EQU	83h
       00000084            B    76    ffs_flseek:		EQU	84h
       00000085            B    77    ffs_ftruncate:		EQU	85h
       00000086            B    78    ffs_fsync:		EQU	86h
       00000087            B    79    ffs_fforward:		EQU	87h
       00000088            B    80    ffs_fexpand:		EQU	88h
       00000089            B    81    ffs_fgets:		EQU	89h
       0000008A            B    82    ffs_fputc:		EQU	8Ah
       0000008B            B    83    ffs_fputs:		EQU	8Bh
       0000008C            B    84    ffs_fprintf:		EQU	8Ch
       0000008D            B    85    ffs_ftell:		EQU	8Dh
       0000008E            B    86    ffs_feof:		EQU	8Eh
       0000008F            B    87    ffs_fsize:		EQU	8Fh
       00000090            B    88    ffs_ferror:		EQU	90h
                           B    89    
                           B    90    ; FatFS directory access functions
                           B    91    ;
       00000091            B    92    ffs_dopen:		EQU	91h
       00000092            B    93    ffs_dclose:		EQU	92h
       00000093            B    94    ffs_dread:		EQU	93h
       00000094            B    95    ffs_dfindfirst:		EQU	94h
       00000095            B    96    ffs_dfindnext:		EQU	95h
                           B    97    
                           B    98    ; FatFS file and directory management functions
                           B    99    ;
       00000096            B   100    ffs_stat:		EQU	96h
       00000097            B   101    ffs_unlink:		EQU	97h
       00000098            B   102    ffs_rename:		EQU	98h
       00000099            B   103    ffs_chmod:		EQU	99h
       0000009A            B   104    ffs_utime:		EQU	9Ah
       0000009B            B   105    ffs_mkdir:		EQU	9Bh
       0000009C            B   106    ffs_chdir:		EQU	9Ch
       0000009D            B   107    ffs_chdrive:		EQU	9Dh
       0000009E            B   108    ffs_getcwd:		EQU	9Eh
                           B   109    
                           B   110    ; FatFS volume management and system configuration functions
                           B   111    ;
       0000009F            B   112    ffs_mount:		EQU	9Fh
       000000A0            B   113    ffs_mkfs:		EQU	A0h
       000000A1            B   114    ffs_fdisk		EQU	A1h
       000000A2            B   115    ffs_getfree:		EQU	A2h
       000000A3            B   116    ffs_getlabel:		EQU	A3h
       000000A4            B   117    ffs_setlabel:		EQU	A4h
       000000A5            B   118    ffs_setcp:		EQU	A5h
                           B   119    	
                           B   120    ; File access modes
                           B   121    ;
       00000001            B   122    fa_read:		EQU	01h
       00000002            B   123    fa_write:		EQU	02h
       00000000            B   124    fa_open_existing:	EQU	00h
       00000004            B   125    fa_create_new:		EQU	04h
       00000008            B   126    fa_create_always:	EQU	08h
       00000010            B   127    fa_open_always:		EQU	10h
       00000030            B   128    fa_open_append:		EQU	30h
                           B   129    	
                           B   130    ; System variable indexes for api_sysvars
                           B   131    ; Index into _sysvars in globals.asm
                           B   132    ;
       00000000            B   133    sysvar_time:		EQU	00h	; 4: Clock timer in centiseconds (incremented by 2 every VBLANK)
       00000004            B   134    sysvar_vpd_pflags:	EQU	04h	; 1: Flags to indicate completion of VDP commands
       00000005            B   135    sysvar_keyascii:	EQU	05h	; 1: ASCII keycode, or 0 if no key is pressed
       00000006            B   136    sysvar_keymods:		EQU	06h	; 1: Keycode modifiers
       00000007            B   137    sysvar_cursorX:		EQU	07h	; 1: Cursor X position
       00000008            B   138    sysvar_cursorY:		EQU	08h	; 1: Cursor Y position
       00000009            B   139    sysvar_scrchar:		EQU	09h	; 1: Character read from screen
       0000000A            B   140    sysvar_scrpixel:	EQU	0Ah	; 3: Pixel data read from screen (R,B,G)
       0000000D            B   141    sysvar_audioChannel:	EQU	0Dh	; 1: Audio channel 
       0000000E            B   142    sysvar_audioSuccess:	EQU	0Eh	; 1: Audio channel note queued (0 = no, 1 = yes)
       0000000F            B   143    sysvar_scrWidth:	EQU	0Fh	; 2: Screen width in pixels
       00000011            B   144    sysvar_scrHeight:	EQU	11h	; 2: Screen height in pixels
       00000013            B   145    sysvar_scrCols:		EQU	13h	; 1: Screen columns in characters
       00000014            B   146    sysvar_scrRows:		EQU	14h	; 1: Screen rows in characters
       00000015            B   147    sysvar_scrColours:	EQU	15h	; 1: Number of colours displayed
       00000016            B   148    sysvar_scrpixelIndex:	EQU	16h	; 1: Index of pixel data read from screen
       00000017            B   149    sysvar_vkeycode:	EQU	17h	; 1: Virtual key code from FabGL
       00000018            B   150    sysvar_vkeydown		EQU	18h	; 1: Virtual key state from FabGL (0=up, 1=down)
       00000019            B   151    sysvar_vkeycount:	EQU	19h	; 1: Incremented every time a key packet is received
       0000001A            B   152    sysvar_rtc:		EQU	1Ah	; 8: Real time clock data
       00000022            B   153    sysvar_keydelay:	EQU	22h	; 2: Keyboard repeat delay
       00000024            B   154    sysvar_keyrate:		EQU	24h	; 2: Keyboard repeat reat
       00000026            B   155    sysvar_keyled:		EQU	26h	; 1: Keyboard LED status
                           B   156    	
                           B   157    ; Flags for the VPD protocol
                           B   158    ;
       00000001            B   159    vdp_pflag_cursor:	EQU	00000001b
       00000002            B   160    vdp_pflag_scrchar:	EQU	00000010b
       00000004            B   161    vdp_pflag_point:	EQU	00000100b
       00000008            B   162    vdp_pflag_audio:	EQU	00001000b
       00000010            B   163    vdp_pflag_mode:		EQU	00010000b
       00000020            B   164    vdp_pflag_rtc:		EQU	00100000b
                           B   165    
                           B   166    ;
                           B   167    ; FatFS structures
                           B   168    ; These mirror the structures contained in src_fatfs/ff.h in the MOS project
                           B   169    ;
                           B   170    ; Object ID and allocation information (FFOBJID)
                           B   171    ;
                           B   172    FFOBJID	.STRUCT
000000                     B   173    	fs:		DS	3	; Pointer to the hosting volume of this object
000003                     B   174    	id:		DS	2	; Hosting volume mount ID
000005                     B   175    	attr:		DS	1	; Object attribute
000006                     B   176    	stat:		DS	1	; Object chain status (b1-0: =0:not contiguous, =2:contiguous, =3:fragmente
000007                     B   177    	sclust:		DS	4	; Object data start cluster (0:no cluster or root directory)
00000B                     B   178    	objsize:	DS	4	; Object size (valid when sclust != 0)
       0000000F            B   179    FFOBJID_SIZE .ENDSTRUCT FFOBJID
                           B   180    ;
                           B   181    ; File object structure (FIL)
                           B   182    ;
                           B   183    FIL .STRUCT
000000                     B   184    	obj:		.TAG	FFOBJID	; Object identifier
00000F                     B   185    	flag:		DS	1	; File status flags
000010                     B   186    	err:		DS	1	; Abort flag (error code)
000011                     B   187    	fptr:		DS	4	; File read/write pointer (Zeroed on file open)
000015                     B   188    	clust:		DS	4	; Current cluster of fpter (invalid when fptr is 0)
000019                     B   189    	sect:		DS	4	; Sector number appearing in buf[] (0:invalid)
00001D                     B   190    	dir_sect:	DS	4	; Sector number containing the directory entry
000021                     B   191    	dir_ptr:	DS	3	; Pointer to the directory entry in the win[]
       00000024            B   192    FIL_SIZE .ENDSTRUCT FIL
                           B   193    ;
                           B   194    ; Directory object structure (DIR)
                           B   195    ; 
                           B   196    DIR .STRUCT
000000                     B   197    	obj:		.TAG	FFOBJID	; Object identifier
00000F                     B   198    	dptr:		DS	4	; Current read/write offset
000013                     B   199    	clust:		DS	4	; Current cluster
000017                     B   200    	sect:		DS	4	; Current sector (0:Read operation has terminated)
00001B                     B   201    	dir:		DS	3	; Pointer to the directory item in the win[]
00001E                     B   202    	fn:		DS	12	; SFN (in/out) {body[8],ext[3],status[1]}
00002A                     B   203    	blk_ofs:	DS	4	; Offset of current entry block being processed (0xFFFFFFFF:Invalid)
       0000002E            B   204    DIR_SIZE .ENDSTRUCT DIR
                           B   205    ;
                           B   206    ; File information structure (FILINFO)
                           B   207    ;
                           B   208    FILINFO .STRUCT
000000                     B   209    	fsize:		DS 	4	; File size
000004                     B   210    	fdate:		DS	2	; Modified date
000006                     B   211    	ftime:		DS	2	; Modified time
000008                     B   212    	fattrib:	DS	1	; File attribute
000009                     B   213    	altname:	DS	13	; Alternative file name
000016                     B   214    	fname:		DS	256	; Primary file name
       00000116            B   215    FILINFO_SIZE .ENDSTRUCT FILINFO
                           B   216    
                           B   217    ;
                           B   218    ; Macro for calling the API
                           B   219    ; Parameters:
                           B   220    ; - function: One of the function numbers listed above
                           B   221    ;
                           B   222    MOSCALL:		MACRO	function
                           B   223    			LD	A, function
                           B   224    			RST.LIS	08h
                           B   225    			ENDMACRO
                           B   226    
                           B   227    MOSCALL24:		MACRO	function
                           B   228    			LD	A, function
                           B   229    			RST.LIL	08h
                           B   230    			ENDMACRO	
                           B   231    ;	print string terminated by 0
                           B   232    ;	Entry: HL pointing to string
                           B   233    ;	destroys a,bc
                           B   234    Print0:	MACRO
                           B   235    		XOR	A
                           B   236    		LD	BC,0		;inefficient - used this way so that 24 bit version will also work
                           B   237    		RST.LIS	18h
                           B   238    		ENDMACRO 
                           B   239    
                           B   240    Print$:	MACRO
                           B   241    		LD	a,'$'
                           B   242    		LD	BC,0		;inefficient - used this way so that 24 bit version will also work
                           B   243    		RST.LIS	18h
                           B   244    		ENDMACRO 
                           B   245    
                           B   246    
                           B   247    DSP:	MACRO
                           B   248    		RST.LIS	10h
                           B   249    		ENDMACRO
                           B   250    
                           B   251    DebugCS:	MACRO	Dchar
                           B   252    			LD	a,Dchar
                           B   253    			RST.LIS	10h
                           B   254    			ENDMACRO
                           B   255    
                           B   256    DebugCL:	MACRO	Dchar
                           B   257    			LD	a,Dchar
                           B   258    			RST.LIL	10h
                           B   259    			ENDMACRO
                           A    28    
                           A    29    
                           A    30    			SEGMENT CODE
                           A    31    
                           A    32    			XDEF	_main
                           A    33    	
                           A    34    ; Error: Invalid parameter
                           A    35    ;
000142 211300              A    36    _err_invalid_param:	LD		HL, 19			; The return code: Invalid parameters
000145 C9                  A    37    			RET
       000000C0            A    38    UART0_PORT		EQU	%C0		; UART0
                           A    39    				
       000000C0            A    40    UART0_REG_RBR:		EQU	UART0_PORT+0	; Receive buffer
       000000C0            A    41    UART0_REG_THR:		EQU	UART0_PORT+0	; Transmitter holding
       000000C0            A    42    UART0_REG_DLL:		EQU	UART0_PORT+0	; Divisor latch low
       000000C1            A    43    UART0_REG_IER:		EQU	UART0_PORT+1	; Interrupt enable
       000000C1            A    44    UART0_REG_DLH:		EQU	UART0_PORT+1	; Divisor latch high
       000000C2            A    45    UART0_REG_IIR:		EQU	UART0_PORT+2	; Interrupt identification
       000000C2            A    46    UART0_REG_FCT:		EQU	UART0_PORT+2;	; Flow control
       000000C3            A    47    UART0_REG_LCR:		EQU	UART0_PORT+3	; Line control
       000000C4            A    48    UART0_REG_MCR:		EQU	UART0_PORT+4	; Modem control
       000000C5            A    49    UART0_REG_LSR:		EQU	UART0_PORT+5	; Line status
       000000C6            A    50    UART0_REG_MSR:		EQU	UART0_PORT+6	; Modem status
       000000C7            A    51    UART0_REG_SCR:		EQU 	UART0_PORT+7	; Scratch
                           A    52    
       00004000            A    53    TX_WAIT			EQU	16384 		; Count before a TX times out
                           A    54    
       00000080            A    55    UART_LSR_ERR		EQU 	%80		; Error
       00000040            A    56    UART_LSR_ETX		EQU 	%40		; Transmit empty
       00000020            A    57    UART_LSR_ETH		EQU	%20		; Transmit holding register empty
       00000001            A    58    UART_LSR_RDY		EQU	%01		; Data ready
                           A    59    ; Get a GPIO register
                           A    60    ; Parameters:
                           A    61    ; - REG: Register to test
                           A    62    ; - VAL: Bit(s) to test
                           A    63    ;	
                           A    64    GET_GPIO:		MACRO	REG, VAL
                           A    65    			IN0	A,(REG)
                           A    66    			TST	A, VAL
                           A    67    			ENDMACRO
                           A    68    
       0000000D            A    69    cr:			EQU	0Dh
       0000000A            A    70    lf:			EQU	0Ah
                           A    71    
                           A    72    ; ASCII
                           A    73    ;
       00000003            A    74    CtrlC:	equ	03h
                           A    75    CR:	equ	0Dh
                           A    76    LF:	equ	0Ah
       0000001A            A    77    CtrlZ:	equ	1Ah
                           A    78    ;
                           A    79    
                           A    80    ;_main:
                           A    81    ; RAM
                           A    82    ; 
                           A    83    			DEFINE	LORAM, SPACE = ROM
                           A    84    ;			ORDER	__VECTORS, CODE, LORAM
                           A    85    ;			SEGMENT LORAM
                           A    86    		
                           A    87    ;			SEGMENT	BSS
                           A    88    			SEGMENT CODE
                           A    89    
                           A    90    ;***********************************************************
                           A    91    ; Terminal mode Serial I/O
                           A    92    
                           A    93    ;
                           A    94    ; Check whether we're clear to send (UART0 only)
                           A    95    ;
                           A    96    
000146                     A    97    UART0_wait_CTS:		GET_GPIO	PD_DR, 8		; Check Port D, bit 3 (CTS)
00014C 20 F8               A    98    			JR		NZ, UART0_wait_CTS
00014E C9                  A    99    			RET
                           A   100    
                           A   101    ; Write a character to UART0
                           A   102    ; Parameters:
                           A   103    ; - A: Data to write
                           A   104    ; Returns:
                           A   105    ; - F: C if written
                           A   106    ; - F: NC if timed out
                           A   107    ;
00014F C5                  A   108    UART0_serial_TX:	PUSH		BC			; Stack BC
000150 F5                  A   109    			PUSH		AF 			; Stack AF
000151 CD 46 01            A   110    			CALL	UART0_wait_CTS
000154 010040              A   111    			LD		BC,TX_WAIT		; Set CB to the transmit timeout
000157 ED38C5              A   112    UART0_serial_TX1:	IN0		A,(UART0_REG_LSR)	; Get the line status register
00015A E640                A   113    			AND 		UART_LSR_ETX		; Check for TX empty
00015C 20 09               A   114    			JR		NZ, UART0_serial_TX2	; If set, then TX is empty, goto transmit
00015E 0B                  A   115    			DEC		BC
00015F 78                  A   116    			LD		A, B
000160 B1                  A   117    			OR		C
000161 20 F4               A   118    			JR		NZ, UART0_serial_TX1
000163 F1                  A   119    			POP		AF			; We've timed out at this point so
000164 C1                  A   120    			POP		BC			; Restore the stack
000165 B7                  A   121    			OR		A			; Clear the carry flag and preserve A
000166 C9                  A   122    			RET	
000167 F1                  A   123    UART0_serial_TX2:	POP		AF			; Good to send at this point, so
000168 ED39C0              A   124    			OUT0		(UART0_REG_THR),A	; Write the character to the UART transmit buffer
00016B C1                  A   125    			POP		BC			; Restore BC
00016C 37                  A   126    			SCF					; Set the carry flag
00016D C9                  A   127    			RET 
                           A   128    ; Read a character from UART0
                           A   129    ; Returns:
                           A   130    ; - A: Data read
                           A   131    ; - F: C if character read
                           A   132    ; - F: NC if no character read
                           A   133    ;
00016E ED38C5              A   134    UART0_serial_RX:	IN0		A,(UART0_REG_LSR)	; Get the line status register
000171 E601                A   135    			AND 		UART_LSR_RDY		; Check for characters in buffer
000173 C8                  A   136    			RET		Z			; Just ret (with carry clear) if no characters
000174                     A   137    UART0_serial_RX2:
000174 ED38C0              A   138    			IN0		A,(UART0_REG_RBR)	; Read the character from the UART receive buffer
000177 37                  A   139    			SCF 					; Set the carry flag
000178 C9                  A   140    			RET
                           A   141    
                           A   142    ; 2048
                           A   143    ;
                           A   144    ; Join the numbers and get to the 2048 tile.
                           A   145    ;
                           A   146    ; Commands:
                           A   147    ;
                           A   148    ;   Use the arrow keys to move the tiles.
                           A   149    ;   When two tiles with the same number touch, they merge into one.
                           A   150    ;
                           A   151    ;   w, s, a, d - Alternate keys (up, down, left, right)
                           A   152    ;   CTRL-E, CTRL-X, CTRL-S, CTRL-D - Wordstar-compatible control keys
                           A   153    ;
                           A   154    ; Compile:
                           A   155    ;
                           A   156    ;   TASM -80 -b 2048.ASM 2048.COM
                           A   157    ;   -or-
                           A   158    ;   uz80as 2048.ASM 2048.COM
                           A   159    ;
                           A   160    ; Credits:
                           A   161    ;
                           A   162    ;   Based on 2048 created by Gabriele Cirulli.
                           A   163    ;   Based on the console version for GNU/Linux by Maurits van der Schee
                           A   164    ;   Ported to Z80 and CP/M by Marco Maccaferri <macca@maccasoft.com>
                           A   165    ;   Slight VT100 compatibility changes by acn128 <acn@acn.wtf>
                           A   166    
                           A   167    
       00000001            A   168    CTRL_A      .EQU    1
       00000002            A   169    CTRL_B      .EQU    2
       00000003            A   170    CTRL_C      .EQU    3
       00000004            A   171    CTRL_D      .EQU    4
       00000005            A   172    CTRL_E      .EQU    5
       00000006            A   173    CTRL_F      .EQU    6
       00000007            A   174    CTRL_G      .EQU    7
       00000008            A   175    CTRL_H      .EQU    8
       00000009            A   176    CTRL_I      .EQU    9
       0000000A            A   177    CTRL_J      .EQU    10
       0000000B            A   178    CTRL_K      .EQU    11
       0000000C            A   179    CTRL_L      .EQU    12
       0000000D            A   180    CTRL_M      .EQU    13
       0000000E            A   181    CTRL_N      .EQU    14
       0000000F            A   182    CTRL_O      .EQU    15
       00000010            A   183    CTRL_P      .EQU    16
       00000011            A   184    CTRL_Q      .EQU    17
       00000012            A   185    CTRL_R      .EQU    18
       00000013            A   186    CTRL_S      .EQU    19
       00000014            A   187    CTRL_T      .EQU    20
       00000015            A   188    CTRL_U      .EQU    21
       00000016            A   189    CTRL_V      .EQU    22
       00000017            A   190    CTRL_W      .EQU    23
       00000018            A   191    CTRL_X      .EQU    24
       00000019            A   192    CTRL_Y      .EQU    25
       0000001A            A   193    CTRL_Z      .EQU    26
                           A   194    
       00000007            A   195    BEL         .EQU    07H
       0000000C            A   196    FF          .EQU    0CH
                           A   197    CR          .EQU    0DH
                           A   198    LF          .EQU    0AH
       00000024            A   199    EOS         .EQU    '$'	;24H
                           A   200    
                           A   201    ;BDOS        .EQU    0005H
                           A   202    
       00000025            A   203    BOARD_X     .EQU    25H
       00000006            A   204    BOARD_Y     .EQU    06H
                           A   205    
                           A   206    ;            .ORG    0100H
000179                     A   207    _main:            
000179 ED5F                A   208                LD      A,R
00017B 32 CF 06            A   209                LD      (RAND16+1),A
00017E ED5F                A   210                LD      A,R
000180 32 D0 06            A   211                LD      (RAND16+2),A
                           A   212    
                           A   213    ;Disable interrupts from UART0 before switching (MOS 3 change to do this prior to terminal mode)
000183 AF                  A   214        xor   a
000184 ED39C1              A   215        out0  (UART0_REG_IER), a ; Disable all interrupts on UART0.
                           A   216    
000187 3E06                A   217        ld    a, 6
000189 ED39C2              A   218        out0  (UART0_REG_FCT), a ; Turn off flow control interrupt
                           A   219    
00018C 11 65 08            A   220                LD      DE,INIT
                           A   221    ;            LD      C,09H
00018F CD 01 07            A   222    	CALL	show_string_de
                           A   223    
000192 CD B0 03            A   224                CALL    ADDRANDOM
000195 CD B0 03            A   225                CALL    ADDRANDOM
                           A   226    
000198 CD 34 05            A   227                CALL    DRAWBORDER
00019B CD 9A 05            A   228                CALL    DRAWBOARD
                           A   229    
00019E 3E25                A   230    LOOP2       LD      A,BOARD_X
0001A0 32 51 09            A   231                LD      (XPOS),A
0001A3 3E06                A   232                LD      A,BOARD_Y
0001A5 C613                A   233                ADD     A,13H
0001A7 27                  A   234                DAA
0001A8 32 52 09            A   235                LD      (YPOS),A
0001AB CD 74 06            A   236                CALL    GOTOXY
0001AE 11 CA 08            A   237                LD      DE,MSG1
                           A   238    ;            LD      C,09H
0001B1 CD 01 07            A   239                CALL    show_string_de
                           A   240    
0001B4                     A   241    LOOP:
                           A   242    ;            LD      C,06H
                           A   243    ;            LD      E,0FFH
                           A   244    ;            CALL    BDOS
                           A   245    ;            CP      0
                           A   246    ;            JP      Z,LOOP
0001B4 CD 6E 01            A   247    		call	UART0_serial_RX
0001B7 30 FB               A   248    		jr		nc,LOOP
                           A   249                
0001B9 FE61                A   250                CP      'a'
0001BB DA C5 01            A   251                JP      C,K3
0001BE FE7B                A   252                CP      '{'
0001C0 D2 C5 01            A   253                JP      NC,K3
0001C3 E65F                A   254                AND     5FH		;force upper case
                           A   255    
0001C5 FE03                A   256    K3:          CP      CTRL_C
0001C7 CA D2 02            A   257                JP      Z,EXIT
                           A   258    
0001CA FE05                A   259                CP      CTRL_E
0001CC CA 4B 02            A   260                JP      Z,TOP
0001CF FE18                A   261                CP      CTRL_X
0001D1 CA 5D 02            A   262                JP      Z,BOTTOM
0001D4 FE04                A   263                CP      CTRL_D
0001D6 CA 6F 02            A   264                JP      Z,RIGHT
0001D9 FE13                A   265                CP      CTRL_S
0001DB CA 81 02            A   266                JP      Z,LEFT
                           A   267    
0001DE FE57                A   268                CP      'W'
0001E0 CA 4B 02            A   269                JP      Z,TOP
0001E3 FE53                A   270                CP      'S'
0001E5 CA 5D 02            A   271                JP      Z,BOTTOM
0001E8 FE44                A   272                CP      'D'
0001EA CA 6F 02            A   273                JP      Z,RIGHT
0001ED FE41                A   274                CP      'A'
0001EF CA 81 02            A   275                JP      Z,LEFT
                           A   276    
0001F2 FE51                A   277                CP      'Q'
0001F4 CA 87 02            A   278                JP      Z,QUIT
                           A   279                
0001F7 FE1B                A   280                CP      1BH
0001F9 CA 04 02            A   281                JP      Z,K1
                           A   282    
                           A   283    ;            LD      C,02H
0001FC 3E07                A   284                LD      A,BEL
0001FE CD 4F 01            A   285                CALL    UART0_serial_TX
                           A   286    
000201 C3 B4 01            A   287                JP      LOOP
                           A   288    
000204                     A   289    K1:
                           A   290    ;          LD      C,06H
                           A   291    ;            LD      E,0FFH
                           A   292    ;            CALL    BDOS
                           A   293    ;            CP      0
                           A   294    ;            JP      Z,K1
000204 CD 6E 01            A   295    		call	UART0_serial_RX
000207 30 FB               A   296    		jr		nc,K1            
000209 FE4F                A   297                CP      'O'
00020B C2 13 02            A   298                JP      NZ,K2
                           A   299    
00020E                     A   300    K4:
                           A   301    ;          LD      C,06H
                           A   302    ;            LD      E,0FFH
                           A   303    ;            CALL    BDOS
                           A   304    ;            CP      0
                           A   305    ;            JP      Z,K4
00020E CD 6E 01            A   306    		call	UART0_serial_RX
000211 30 FB               A   307    		jr		nc,K4
                           A   308    
000213 FE41                A   309    K2:          CP      'A'
000215 CA 4B 02            A   310                JP      Z,TOP
000218 FE42                A   311                CP      'B'
00021A CA 5D 02            A   312                JP      Z,BOTTOM
00021D FE43                A   313                CP      'C'
00021F CA 6F 02            A   314                JP      Z,RIGHT
000222 FE44                A   315                CP      'D'
000224 CA 81 02            A   316                JP      Z,LEFT
                           A   317    
                           A   318    ;            LD      C,02H
000227 3E07                A   319                LD      A,BEL
000229 CD 4F 01            A   320                CALL    UART0_serial_TX
                           A   321    
00022C C3 B4 01            A   322                JP      LOOP
                           A   323    
00022F 3A 55 09            A   324    LOOP1       LD      A,(MOVED)
000232 FE00                A   325                CP      0
000234 CA B4 01            A   326                JP      Z,LOOP
                           A   327    
000237 CD 9A 05            A   328                CALL    DRAWBOARD
                           A   329    
00023A CD B0 03            A   330                CALL    ADDRANDOM
00023D CD 9A 05            A   331                CALL    DRAWBOARD
                           A   332    
000240 CD E8 02            A   333                CALL    ISOVER
000243 FE01                A   334                CP      1
000245 CA BE 02            A   335                JP      Z,GAMEOVER
                           A   336    
000248 C3 B4 01            A   337                JP      LOOP
                           A   338    
00024B                     A   339    TOP:
00024B CD 51 04            A   340                CALL    ROTATE
00024E CD 51 04            A   341                CALL    ROTATE
000251 CD 51 04            A   342                CALL    ROTATE
000254 CD 87 03            A   343                CALL    MOVEMERGE
000257 CD 51 04            A   344                CALL    ROTATE
00025A C3 2F 02            A   345                JP      LOOP1
                           A   346    
00025D                     A   347    BOTTOM:
00025D CD 51 04            A   348                CALL    ROTATE
000260 CD 87 03            A   349                CALL    MOVEMERGE
000263 CD 51 04            A   350                CALL    ROTATE
000266 CD 51 04            A   351                CALL    ROTATE
000269 CD 51 04            A   352                CALL    ROTATE
00026C C3 2F 02            A   353                JP      LOOP1
                           A   354    
00026F                     A   355    RIGHT:
00026F CD 51 04            A   356                CALL    ROTATE
000272 CD 51 04            A   357                CALL    ROTATE
000275 CD 87 03            A   358                CALL    MOVEMERGE
000278 CD 51 04            A   359                CALL    ROTATE
00027B CD 51 04            A   360                CALL    ROTATE
00027E C3 2F 02            A   361                JP      LOOP1
                           A   362    
000281                     A   363    LEFT:
000281 CD 87 03            A   364                CALL    MOVEMERGE
000284 C3 2F 02            A   365                JP      LOOP1
                           A   366    
000287                     A   367    QUIT:
000287 3E25                A   368                LD      A,BOARD_X
000289 32 51 09            A   369                LD      (XPOS),A
00028C 3E06                A   370                LD      A,BOARD_Y
00028E C613                A   371                ADD     A,13H
000290 27                  A   372                DAA
000291 32 52 09            A   373                LD      (YPOS),A
000294 CD 74 06            A   374                CALL    GOTOXY
000297 11 EB 08            A   375                LD      DE,MSG2
                           A   376     ;           LD      C,09H
00029A CD 01 07            A   377                CALL    show_string_de
                           A   378    
00029D                     A   379    Q1:
                           A   380    ;          LD      C,06H
                           A   381    ;            LD      E,0FFH
                           A   382    
                           A   383    ;            CP      0
00029D CD 6E 01            A   384    		call	UART0_serial_RX
0002A0 30 FB               A   385    		jr		nc,Q1	
                           A   386    ;            JP      Z,Q1
                           A   387    
0002A2 FE79                A   388                CP      'y'
0002A4 CA D2 02            A   389                JP      Z,EXIT
0002A7 FE59                A   390                CP      'Y'
0002A9 CA D2 02            A   391                JP      Z,EXIT
0002AC FE6E                A   392                CP      'n'
0002AE CA 9E 01            A   393                JP      Z,LOOP2
0002B1 FE4E                A   394                CP      'N'
0002B3 CA 9E 01            A   395                JP      Z,LOOP2
                           A   396    
                           A   397    ;            LD      C,02H
0002B6 3E07                A   398                LD      A,BEL
0002B8 CD 4F 01            A   399                CALL    UART0_serial_TX
0002BB C3 9D 02            A   400                JP      Q1
                           A   401    
0002BE                     A   402    GAMEOVER:
0002BE 3E25                A   403                LD      A,BOARD_X
0002C0 32 51 09            A   404                LD      (XPOS),A
0002C3 3E19                A   405                LD      A,BOARD_Y+13H
0002C5 27                  A   406                DAA
0002C6 32 52 09            A   407                LD      (YPOS),A
0002C9 CD 74 06            A   408                CALL    GOTOXY
0002CC 11 0C 09            A   409                LD      DE,MSG3
                           A   410      ;          LD      C,09H
0002CF CD 01 07            A   411                CALL    show_string_de
                           A   412    
0002D2                     A   413    EXIT:
0002D2 11 79 08            A   414                LD      DE,TERM
                           A   415     ;           LD      C,09H
0002D5 CD 01 07            A   416                CALL    show_string_de
0002D8 3E24                A   417                ld		a,'$'
0002DA CD 4F 01            A   418                call	UART0_serial_TX
                           A   419    ;turn interrupts back on
0002DD 3E07                A   420        ld    a, 7
0002DF ED39C2              A   421        out0  (UART0_REG_FCT), a ; Enable and clear fifo
0002E2 3E01                A   422        ld a, 1
0002E4 ED39C1              A   423        out0 (UART0_REG_IER), a ; Enable receive interrupt  
0002E7 C9                  A   424                RET
                           A   425    
0002E8                     A   426    ISOVER:
0002E8 3E01                A   427                LD      A,1
0002EA 32 56 09            A   428                LD      (RESULT),A
                           A   429    
0002ED 0610                A   430                LD      B,16
0002EF 21 0B 07            A   431                LD      HL,BOARD
0002F2 7E                  A   432    G1:         LD      A,(HL)
0002F3 FE0D                A   433                CP      13
0002F5 CA 37 03            A   434                JP      Z,GR
0002F8 23                  A   435                INC     HL
0002F9 10 F7               A   436                DJNZ    G1
                           A   437    
0002FB CD 3B 03            A   438                CALL    CANMERGE
0002FE FE00                A   439                CP      0
000300 CA 07 03            A   440                JP      Z,G2
000303 AF                  A   441                XOR     A
000304 32 56 09            A   442                LD      (RESULT),A
                           A   443    
000307 CD 51 04            A   444    G2:         CALL    ROTATE
00030A CD 3B 03            A   445                CALL    CANMERGE
00030D FE00                A   446                CP      0
00030F CA 16 03            A   447                JP      Z,G3
000312 AF                  A   448                XOR     A
000313 32 56 09            A   449                LD      (RESULT),A
                           A   450    
000316 CD 51 04            A   451    G3:         CALL    ROTATE
000319 CD 3B 03            A   452                CALL    CANMERGE
00031C FE00                A   453                CP      0
00031E CA 25 03            A   454                JP      Z,G4
000321 AF                  A   455                XOR     A
000322 32 56 09            A   456                LD      (RESULT),A
                           A   457    
000325 CD 51 04            A   458    G4:         CALL    ROTATE
000328 CD 3B 03            A   459                CALL    CANMERGE
00032B FE00                A   460                CP      0
00032D CA 34 03            A   461                JP      Z,G5
000330 AF                  A   462                XOR     A
000331 32 56 09            A   463                LD      (RESULT),A
                           A   464    
000334 CD 51 04            A   465    G5:         CALL    ROTATE
                           A   466    
000337 3A 56 09            A   467    GR:         LD      A,(RESULT)
00033A C9                  A   468                RET
                           A   469    
00033B                     A   470    CANMERGE:
00033B 21 0B 07            A   471                LD      HL,BOARD
00033E 22 53 09            A   472                LD      (BOARDPTR),HL
000341 CD 69 03            A   473                CALL    TESTMERGE
000344 FE01                A   474                CP      1
000346 C8                  A   475                RET     Z
000347 21 0F 07            A   476                LD      HL,BOARD+4
00034A 22 53 09            A   477                LD      (BOARDPTR),HL
00034D CD 69 03            A   478                CALL    TESTMERGE
000350 FE01                A   479                CP      1
000352 C8                  A   480                RET     Z
000353 21 13 07            A   481                LD      HL,BOARD+8
000356 22 53 09            A   482                LD      (BOARDPTR),HL
000359 CD 69 03            A   483                CALL    TESTMERGE
00035C FE01                A   484                CP      1
00035E C8                  A   485                RET     Z
00035F 21 17 07            A   486                LD      HL,BOARD+12
000362 22 53 09            A   487                LD      (BOARDPTR),HL
000365 CD 69 03            A   488                CALL    TESTMERGE
000368 C9                  A   489                RET
                           A   490    
000369                     A   491    TESTMERGE:
000369 ED5B 53 09          A   492                LD      DE,(BOARDPTR)
00036D 2A 53 09            A   493                LD      HL,(BOARDPTR)
000370 23                  A   494                INC     HL
                           A   495    
000371 0603                A   496                LD      B,3
000373 1A                  A   497    M8          LD      A,(DE)
000374 FE00                A   498                CP      0
000376 CA 84 03            A   499                JP      Z,M7
000379 4E                  A   500                LD      C,(HL)
00037A B9                  A   501                CP      C
00037B CA 84 03            A   502                JP      Z,M7
00037E 23                  A   503                INC     HL
00037F 13                  A   504                INC     DE
000380 10 F1               A   505                DJNZ    M8
000382 AF                  A   506                XOR     A
000383 C9                  A   507                RET
000384 3E01                A   508    M7          LD      A,1
000386 C9                  A   509                RET
                           A   510    
000387                     A   511    MOVEMERGE:
000387 AF                  A   512                XOR     A
000388 32 55 09            A   513                LD      (MOVED),A
                           A   514    
00038B 21 0B 07            A   515                LD      HL,BOARD
00038E 22 53 09            A   516                LD      (BOARDPTR),HL
000391 CD FB 03            A   517                CALL    MERGE
000394 21 0F 07            A   518                LD      HL,BOARD+4
000397 22 53 09            A   519                LD      (BOARDPTR),HL
00039A CD FB 03            A   520                CALL    MERGE
00039D 21 13 07            A   521                LD      HL,BOARD+8
0003A0 22 53 09            A   522                LD      (BOARDPTR),HL
0003A3 CD FB 03            A   523                CALL    MERGE
0003A6 21 17 07            A   524                LD      HL,BOARD+12
0003A9 22 53 09            A   525                LD      (BOARDPTR),HL
0003AC CD FB 03            A   526                CALL    MERGE
                           A   527    
0003AF C9                  A   528                RET
                           A   529    
0003B0                     A   530    ADDRANDOM:
0003B0 110000              A   531                LD      DE,0
0003B3 0610                A   532                LD      B,16
0003B5 21 0B 07            A   533                LD      HL,BOARD
0003B8 7E                  A   534    N2          LD      A,(HL)
0003B9 FE00                A   535                CP      0
0003BB C2 BF 03            A   536                JP      NZ,N1
0003BE 1C                  A   537                INC     E
0003BF 23                  A   538    N1          INC     HL
0003C0 10 F6               A   539                DJNZ    N2
                           A   540                
0003C2 7B                  A   541                LD      A,E
0003C3 FE00                A   542                CP      0
0003C5 C8                  A   543                RET     Z
                           A   544    
0003C6 D5                  A   545                PUSH    DE
0003C7 CD CE 06            A   546                CALL    RAND16
0003CA D1                  A   547                POP     DE
0003CB CD E9 06            A   548                CALL    DIV16
                           A   549    
0003CE 45                  A   550                LD      B,L
0003CF 0E10                A   551    N4:         LD      C,16
0003D1 21 0B 07            A   552                LD      HL,BOARD
0003D4 7E                  A   553    N5:         LD      A,(HL)
0003D5 FE00                A   554                CP      0
0003D7 C2 DE 03            A   555                JP      NZ,N3
0003DA 05                  A   556                DEC     B
0003DB CA E6 03            A   557                JP      Z,N6
0003DE 23                  A   558    N3:         INC     HL
0003DF 0D                  A   559                DEC     C
0003E0 C2 D4 03            A   560                JP      NZ,N5
0003E3 C3 CF 03            A   561                JP      N4
                           A   562    
0003E6 E5                  A   563    N6          PUSH    HL
                           A   564    
0003E7 CD CE 06            A   565                CALL    RAND16
0003EA 110A00              A   566                LD      DE,10
0003ED CD E9 06            A   567                CALL    DIV16
0003F0 110900              A   568                LD      DE,9
0003F3 CD E9 06            A   569                CALL    DIV16
0003F6 7B                  A   570                LD      A,E
0003F7 3C                  A   571                INC     A
                           A   572                
0003F8 E1                  A   573                POP     HL
0003F9 77                  A   574                LD      (HL),A
                           A   575    
0003FA C9                  A   576                RET
                           A   577    
0003FB                     A   578    MERGE:
0003FB CD 2B 04            A   579                CALL    COLLAPSE
                           A   580    
                           A   581                ; merge tiles with same value
                           A   582    
0003FE ED5B 53 09          A   583                LD      DE,(BOARDPTR)
000402 2A 53 09            A   584                LD      HL,(BOARDPTR)
000405 23                  A   585                INC     HL
                           A   586    
000406 0603                A   587                LD      B,3
000408 1A                  A   588    M6:         LD      A,(DE)
000409 FE00                A   589                CP      0
00040B C8                  A   590                RET     Z
00040C 4E                  A   591                LD      C,(HL)
00040D B9                  A   592                CP      C
00040E C2 26 04            A   593                JP      NZ,M5
                           A   594    
000411 3C                  A   595                INC     A
000412 12                  A   596                LD      (DE),A
000413 CD BA 04            A   597                CALL    ADDPOINTS
000416 AF                  A   598                XOR     A
000417 77                  A   599                LD      (HL),A
                           A   600    
000418 3A 55 09            A   601                LD      A,(MOVED)
00041B 3C                  A   602                INC     A
00041C 32 55 09            A   603                LD      (MOVED),A
                           A   604    
00041F D5                  A   605                PUSH    DE
000420 E5                  A   606                PUSH    HL
000421 CD 2B 04            A   607                CALL    COLLAPSE
000424 E1                  A   608                POP     HL
000425 D1                  A   609                POP     DE
                           A   610    
000426 23                  A   611    M5:         INC     HL
000427 13                  A   612                INC     DE
000428 10 DE               A   613                DJNZ    M6
                           A   614    
00042A C9                  A   615                RET
                           A   616    
00042B                     A   617    COLLAPSE:
                           A   618                ; collapse all tiles
                           A   619    
00042B 2A 53 09            A   620                LD      HL,(BOARDPTR)
                           A   621    
00042E 0604                A   622                LD      B,4             ; find first zero
000430 7E                  A   623    M1:         LD      A,(HL)
000431 FE00                A   624                CP      0
000433 CA 3A 04            A   625                JP      Z,M2
000436 23                  A   626                INC     HL
000437 10 F7               A   627                DJNZ    M1
000439 C9                  A   628                RET
                           A   629    
00043A 5D                  A   630    M2:         LD      E,L             ; DE=fist zero position
00043B 54                  A   631                LD      D,H
                           A   632    
00043C 7E                  A   633    M4:         LD      A,(HL)          ; move all non-zero tiles
00043D FE00                A   634                CP      0
00043F CA 4D 04            A   635                JP      Z,M3
                           A   636    
000442 12                  A   637                LD      (DE),A
000443 13                  A   638                INC     DE
000444 AF                  A   639                XOR     A
000445 77                  A   640                LD      (HL),A
                           A   641    
000446 3A 55 09            A   642                LD      A,(MOVED)
000449 3C                  A   643                INC     A
00044A 32 55 09            A   644                LD      (MOVED),A
                           A   645    
00044D 23                  A   646    M3:         INC     HL
00044E 10 EC               A   647                DJNZ    M4
                           A   648    
000450 C9                  A   649                RET
                           A   650    
000451                     A   651    ROTATE:
                           A   652                ; outer ring
                           A   653    
000451 0603                A   654                LD      B,3
                           A   655    
000453 3A 0E 07            A   656    R1:         LD      A,(BOARD+3)
000456 4F                  A   657                LD      C,A
                           A   658    
000457 3A 0D 07            A   659                LD      A,(BOARD+2)
00045A 32 0E 07            A   660                LD      (BOARD+3),A
00045D 3A 0C 07            A   661                LD      A,(BOARD+1)
000460 32 0D 07            A   662                LD      (BOARD+2),A
000463 3A 0B 07            A   663                LD      A,(BOARD+0)
000466 32 0C 07            A   664                LD      (BOARD+1),A
                           A   665    
000469 3A 0F 07            A   666                LD      A,(BOARD+4)
00046C 32 0B 07            A   667                LD      (BOARD+0),A
00046F 3A 13 07            A   668                LD      A,(BOARD+8)
000472 32 0F 07            A   669                LD      (BOARD+4),A
000475 3A 17 07            A   670                LD      A,(BOARD+12)
000478 32 13 07            A   671                LD      (BOARD+8),A
                           A   672    
00047B 3A 18 07            A   673                LD      A,(BOARD+13)
00047E 32 17 07            A   674                LD      (BOARD+12),A
000481 3A 19 07            A   675                LD      A,(BOARD+14)
000484 32 18 07            A   676                LD      (BOARD+13),A
000487 3A 1A 07            A   677                LD      A,(BOARD+15)
00048A 32 19 07            A   678                LD      (BOARD+14),A
                           A   679    
00048D 3A 16 07            A   680                LD      A,(BOARD+11)
000490 32 1A 07            A   681                LD      (BOARD+15),A
000493 3A 12 07            A   682                LD      A,(BOARD+7)
000496 32 16 07            A   683                LD      (BOARD+11),A
000499 79                  A   684                LD      A,C
00049A 32 12 07            A   685                LD      (BOARD+7),A
                           A   686    
00049D 10 B4               A   687                DJNZ    R1
                           A   688    
                           A   689                ; inner ring
                           A   690    
00049F 3A 11 07            A   691                LD      A,(BOARD+6)
0004A2 4F                  A   692                LD      C,A
                           A   693    
0004A3 3A 10 07            A   694                LD      A,(BOARD+5)
0004A6 32 11 07            A   695                LD      (BOARD+6),A
0004A9 3A 14 07            A   696                LD      A,(BOARD+9)
0004AC 32 10 07            A   697                LD      (BOARD+5),A
0004AF 3A 15 07            A   698                LD      A,(BOARD+10)
0004B2 32 14 07            A   699                LD      (BOARD+9),A
                           A   700    
0004B5 79                  A   701                LD      A,C
0004B6 32 15 07            A   702                LD      (BOARD+10),A
                           A   703    
0004B9 C9                  A   704                RET
                           A   705    
0004BA                     A   706    ADDPOINTS:
0004BA D5                  A   707                PUSH    DE
0004BB E5                  A   708                PUSH    HL
                           A   709    
0004BC 5F                  A   710                LD      E,A
0004BD 1600                A   711                LD      D,0
0004BF 21 49 08            A   712                LD      HL,POINTS
0004C2 19                  A   713                ADD     HL,DE
0004C3 19                  A   714                ADD     HL,DE
0004C4 5E                  A   715                LD      E,(HL)
0004C5 23                  A   716                INC     HL
0004C6 56                  A   717                LD      D,(HL)
                           A   718    
0004C7 3A 5A 09            A   719                LD      A,(SCORE+3)
0004CA 83                  A   720                ADD     A,E
0004CB 27                  A   721                DAA
0004CC 32 5A 09            A   722                LD      (SCORE+3),A
                           A   723    
0004CF 3A 59 09            A   724                LD      A,(SCORE+2)
0004D2 8A                  A   725                ADC     A,D
0004D3 27                  A   726                DAA
0004D4 32 59 09            A   727                LD      (SCORE+2),A
                           A   728    
0004D7 3A 58 09            A   729                LD      A,(SCORE+1)
0004DA CE00                A   730                ADC     A,00H
0004DC 27                  A   731                DAA
0004DD 32 58 09            A   732                LD      (SCORE+1),A
                           A   733    
0004E0 3A 57 09            A   734                LD      A,(SCORE)
0004E3 CE00                A   735                ADC     A,00H
0004E5 27                  A   736                DAA
0004E6 32 57 09            A   737                LD      (SCORE),A
                           A   738    
0004E9 E1                  A   739                POP     HL
0004EA D1                  A   740                POP     DE
0004EB C9                  A   741                RET
                           A   742    
0004EC                     A   743    PRINTSCORE:
0004EC 21 57 09            A   744                LD      HL,SCORE
0004EF 11 5F 09            A   745                LD      DE,SCORESTR+4
0004F2 0604                A   746                LD      B,4
                           A   747    
0004F4 7E                  A   748    P1:         LD      A,(HL)
0004F5 1F                  A   749                RRA
0004F6 1F                  A   750                RRA
0004F7 1F                  A   751                RRA
0004F8 1F                  A   752                RRA
0004F9 E60F                A   753                AND     0FH
0004FB C630                A   754                ADD     A,30H
0004FD 12                  A   755                LD      (DE),A
0004FE 13                  A   756                INC     DE
                           A   757    
0004FF 7E                  A   758                LD      A,(HL)
000500 E60F                A   759                AND     0FH
000502 C630                A   760                ADD     A,30H
000504 12                  A   761                LD      (DE),A
000505 13                  A   762                INC     DE
                           A   763    
000506 23                  A   764                INC     HL
000507 10 EB               A   765                DJNZ    P1
                           A   766    
000509 21 5F 09            A   767                LD      HL,SCORESTR+4
00050C 0607                A   768                LD      B,7
00050E 7E                  A   769    P3:         LD      A,(HL)
00050F FE30                A   770                CP      30H
000511 C2 1A 05            A   771                JP      NZ,P2
000514 3E20                A   772                LD      A,20H
000516 77                  A   773                LD      (HL),A
000517 23                  A   774                INC     HL
000518 10 F4               A   775                DJNZ    P3
                           A   776    
00051A 3E25                A   777    P2:         LD      A,BOARD_X
00051C C616                A   778                ADD     A,16H
00051E 27                  A   779                DAA
00051F 32 51 09            A   780                LD      (XPOS),A
000522 3E06                A   781                LD      A,BOARD_Y
000524 D602                A   782                SUB     02H
000526 27                  A   783                DAA
000527 32 52 09            A   784                LD      (YPOS),A
00052A CD 74 06            A   785                CALL    GOTOXY
                           A   786    
00052D 11 5B 09            A   787                LD      DE,SCORESTR
                           A   788     ;           LD      C,09H
000530 CD 01 07            A   789                CALL    show_string_de
000533 C9                  A   790                RET
                           A   791    
000534                     A   792    DRAWBORDER:
000534 3E25                A   793                LD      A,BOARD_X
000536 32 51 09            A   794                LD      (XPOS),A
000539 3E06                A   795                LD      A,BOARD_Y
00053B D602                A   796                SUB     02H
00053D 27                  A   797                DAA
00053E 32 52 09            A   798                LD      (YPOS),A
000541 CD 74 06            A   799                CALL    GOTOXY
                           A   800    
000544 11 30 09            A   801                LD      DE,MSG4
                           A   802     ;           LD      C,09H
000547 CD 01 07            A   803                CALL    show_string_de
                           A   804    
                           A   805    
00054A 3E25                A   806                LD      A,BOARD_X
00054C D601                A   807                SUB     01H
00054E 27                  A   808                DAA
00054F 32 51 09            A   809                LD      (XPOS),A
000552 3E06                A   810                LD      A,BOARD_Y
000554 D601                A   811                SUB     01H
000556 27                  A   812                DAA
000557 32 52 09            A   813                LD      (YPOS),A
00055A CD 74 06            A   814                CALL    GOTOXY
                           A   815    
00055D 11 8C 08            A   816                LD      DE,TOPBORDER
                           A   817     ;           LD      C,09H
000560 CD 01 07            A   818                CALL    show_string_de
                           A   819    
000563 060C                A   820                LD      B,12
000565 C5                  A   821    L4:         PUSH    BC
000566 3A 52 09            A   822                LD      A,(YPOS)
000569 C601                A   823                ADD     A,1
00056B 27                  A   824                DAA
00056C 32 52 09            A   825                LD      (YPOS),A
00056F CD 74 06            A   826                CALL    GOTOXY
                           A   827     ;           LD      C,02H
000572 3EDB                A   828                LD      A,0DBH
000574 CD 4F 01            A   829                CALL    UART0_serial_TX
000577 11 86 08            A   830                LD      DE,ADVANCE
                           A   831     ;           LD      C,09H
00057A CD 01 07            A   832                CALL    show_string_de
                           A   833     ;           LD      C,02H
00057D 3EDB                A   834                LD      A,0DBH
00057F CD 4F 01            A   835                CALL    UART0_serial_TX
000582 C1                  A   836                POP     BC
000583 05                  A   837                DEC     B
000584 C2 65 05            A   838                JP      NZ,L4
                           A   839    
000587 3A 52 09            A   840                LD      A,(YPOS)
00058A C601                A   841                ADD     A,1
00058C 27                  A   842                DAA
00058D 32 52 09            A   843                LD      (YPOS),A
000590 CD 74 06            A   844                CALL    GOTOXY
000593 11 AB 08            A   845                LD      DE,BTMBORDER
                           A   846     ;           LD      C,09H
000596 CD 01 07            A   847                CALL    show_string_de
                           A   848    
000599 C9                  A   849                RET
                           A   850    
00059A                     A   851    DRAWBOARD:
00059A CD EC 04            A   852                CALL    PRINTSCORE
                           A   853    
00059D 3E25                A   854                LD      A,BOARD_X
00059F 32 51 09            A   855                LD      (XPOS),A
0005A2 3E06                A   856                LD      A,BOARD_Y
0005A4 D601                A   857                SUB     01H
0005A6 27                  A   858                DAA
0005A7 32 52 09            A   859                LD      (YPOS),A
                           A   860    
0005AA 21 0B 07            A   861                LD      HL,BOARD
0005AD 0604                A   862                LD      B,4
0005AF C5                  A   863    L1:         PUSH    BC
                           A   864    
0005B0 E5                  A   865                PUSH    HL
0005B1 3A 52 09            A   866                LD      A,(YPOS)
0005B4 C601                A   867                ADD     A,1
0005B6 27                  A   868                DAA
0005B7 32 52 09            A   869                LD      (YPOS),A
0005BA CD 74 06            A   870                CALL    GOTOXY
0005BD E1                  A   871                POP     HL
                           A   872    
0005BE E5                  A   873                PUSH    HL
0005BF 5E                  A   874                LD      E,(HL)
0005C0 CD 41 06            A   875                CALL    PRINTSPACE
0005C3 E1                  A   876                POP     HL
0005C4 23                  A   877                INC     HL
0005C5 E5                  A   878                PUSH    HL
0005C6 5E                  A   879                LD      E,(HL)
0005C7 CD 41 06            A   880                CALL    PRINTSPACE
0005CA E1                  A   881                POP     HL
0005CB 23                  A   882                INC     HL
0005CC E5                  A   883                PUSH    HL
0005CD 5E                  A   884                LD      E,(HL)
0005CE CD 41 06            A   885                CALL    PRINTSPACE
0005D1 E1                  A   886                POP     HL
0005D2 23                  A   887                INC     HL
0005D3 E5                  A   888                PUSH    HL
0005D4 5E                  A   889                LD      E,(HL)
0005D5 CD 41 06            A   890                CALL    PRINTSPACE
0005D8 CD C3 06            A   891                CALL    NEWLINE
0005DB E1                  A   892                POP     HL
                           A   893    
0005DC 2B                  A   894                DEC     HL
0005DD 2B                  A   895                DEC     HL
0005DE 2B                  A   896                DEC     HL
                           A   897    
0005DF E5                  A   898                PUSH    HL
0005E0 3A 52 09            A   899                LD      A,(YPOS)
0005E3 C601                A   900                ADD     A,1
0005E5 27                  A   901                DAA
0005E6 32 52 09            A   902                LD      (YPOS),A
0005E9 CD 74 06            A   903                CALL    GOTOXY
0005EC E1                  A   904                POP     HL
                           A   905    
0005ED E5                  A   906                PUSH    HL
0005EE 5E                  A   907                LD      E,(HL)
0005EF CD 57 06            A   908                CALL    PRINTLABEL
0005F2 E1                  A   909                POP     HL
0005F3 23                  A   910                INC     HL
0005F4 E5                  A   911                PUSH    HL
0005F5 5E                  A   912                LD      E,(HL)
0005F6 CD 57 06            A   913                CALL    PRINTLABEL
0005F9 E1                  A   914                POP     HL
0005FA 23                  A   915                INC     HL
0005FB E5                  A   916                PUSH    HL
0005FC 5E                  A   917                LD      E,(HL)
0005FD CD 57 06            A   918                CALL    PRINTLABEL
000600 E1                  A   919                POP     HL
000601 23                  A   920                INC     HL
000602 E5                  A   921                PUSH    HL
000603 5E                  A   922                LD      E,(HL)
000604 CD 57 06            A   923                CALL    PRINTLABEL
000607 CD C3 06            A   924                CALL    NEWLINE
00060A E1                  A   925                POP     HL
                           A   926    
00060B 2B                  A   927                DEC     HL
00060C 2B                  A   928                DEC     HL
00060D 2B                  A   929                DEC     HL
                           A   930    
00060E E5                  A   931                PUSH    HL
00060F 3A 52 09            A   932                LD      A,(YPOS)
000612 C601                A   933                ADD     A,1
000614 27                  A   934                DAA
000615 32 52 09            A   935                LD      (YPOS),A
000618 CD 74 06            A   936                CALL    GOTOXY
00061B E1                  A   937                POP     HL
                           A   938    
00061C E5                  A   939                PUSH    HL
00061D 5E                  A   940                LD      E,(HL)
00061E CD 41 06            A   941                CALL    PRINTSPACE
000621 E1                  A   942                POP     HL
000622 23                  A   943                INC     HL
000623 E5                  A   944                PUSH    HL
000624 5E                  A   945                LD      E,(HL)
000625 CD 41 06            A   946                CALL    PRINTSPACE
000628 E1                  A   947                POP     HL
000629 23                  A   948                INC     HL
00062A E5                  A   949                PUSH    HL
00062B 5E                  A   950                LD      E,(HL)
00062C CD 41 06            A   951                CALL    PRINTSPACE
00062F E1                  A   952                POP     HL
000630 23                  A   953                INC     HL
000631 E5                  A   954                PUSH    HL
000632 5E                  A   955                LD      E,(HL)
000633 CD 41 06            A   956                CALL    PRINTSPACE
000636 CD C3 06            A   957                CALL    NEWLINE
000639 E1                  A   958                POP     HL
                           A   959    
00063A 23                  A   960                INC     HL
                           A   961    
00063B C1                  A   962                POP     BC
00063C 05                  A   963                DEC     B
00063D C2 AF 05            A   964                JP      NZ,L1
                           A   965    
000640 C9                  A   966                RET
                           A   967    
000641                     A   968    PRINTSPACE:
000641 1600                A   969                LD      D,0
                           A   970    
000643 D5                  A   971                PUSH    DE
000644 21 AF 07            A   972                LD      HL,COLORPTR
000647 19                  A   973                ADD     HL,DE
000648 19                  A   974                ADD     HL,DE
000649 5E                  A   975                LD      E,(HL)
00064A 23                  A   976                INC     HL
00064B 56                  A   977                LD      D,(HL)
                           A   978     ;           LD      C,09H
00064C CD 01 07            A   979                CALL    show_string_de
00064F D1                  A   980                POP     DE
                           A   981    
000650 11 1B 07            A   982                LD      DE,SPACER
                           A   983     ;           LD      C,09H
000653 CD 01 07            A   984                CALL    show_string_de
                           A   985    
000656 C9                  A   986                RET
                           A   987    
000657                     A   988    PRINTLABEL:
000657 1600                A   989                LD      D,0
                           A   990    
000659 D5                  A   991                PUSH    DE
00065A 21 AF 07            A   992                LD      HL,COLORPTR
00065D 19                  A   993                ADD     HL,DE
00065E 19                  A   994                ADD     HL,DE
00065F 5E                  A   995                LD      E,(HL)
000660 23                  A   996                INC     HL
000661 56                  A   997                LD      D,(HL)
                           A   998     ;           LD      C,09H
000662 CD 01 07            A   999                CALL    show_string_de
000665 D1                  A  1000                POP     DE
                           A  1001    
000666 D5                  A  1002                PUSH    DE
000667 21 23 07            A  1003                LD      HL,LABELPTR
00066A 19                  A  1004                ADD     HL,DE
00066B 19                  A  1005                ADD     HL,DE
00066C 5E                  A  1006                LD      E,(HL)
00066D 23                  A  1007                INC     HL
00066E 56                  A  1008                LD      D,(HL)
                           A  1009    ;            LD      C,09H
00066F CD 01 07            A  1010    	CALL	show_string_de
000672 D1                  A  1011                POP     DE
                           A  1012    
000673 C9                  A  1013                RET
                           A  1014    
000674                     A  1015    GOTOXY:
                           A  1016    ;            LD      C,02H
000674 3E1B                A  1017                LD      a,1BH
000676 CD 4F 01            A  1018                CALL    UART0_serial_TX
                           A  1019    ;            LD      C,02H
000679 3E5B                A  1020                LD      a,'['
00067B CD 4F 01            A  1021                CALL    UART0_serial_TX
                           A  1022    
00067E 3A 52 09            A  1023                LD      A,(YPOS)
000681 FE10                A  1024                CP      10H
000683 DA 94 06            A  1025                JP      C,L2
                           A  1026    
000686 1F                  A  1027                RRA
000687 1F                  A  1028                RRA
000688 1F                  A  1029                RRA
000689 1F                  A  1030                RRA
00068A E60F                A  1031                AND     0FH
00068C C630                A  1032                ADD     A,'0'
                           A  1033    
                           A  1034    ;            LD      C,02H
                           A  1035    ;            LD      E,A
00068E CD 4F 01            A  1036                CALL    UART0_serial_TX
                           A  1037    
000691 3A 52 09            A  1038                LD      A,(YPOS)
                           A  1039    
000694 E60F                A  1040    L2:         AND     0FH
000696 C630                A  1041                ADD     A,'0'
                           A  1042    
                           A  1043    ;            LD      C,02H
                           A  1044    ;            LD      E,A
000698 CD 4F 01            A  1045                CALL    UART0_serial_TX
                           A  1046    
                           A  1047    ;            LD      C,02H
00069B 3E3B                A  1048                LD      A,3BH
00069D CD 4F 01            A  1049                CALL    UART0_serial_TX
                           A  1050    
0006A0 3A 51 09            A  1051                LD      A,(XPOS)
0006A3 FE10                A  1052                CP      10H
0006A5 DA B6 06            A  1053                JP      C,L3
                           A  1054    
0006A8 1F                  A  1055                RRA
0006A9 1F                  A  1056                RRA
0006AA 1F                  A  1057                RRA
0006AB 1F                  A  1058                RRA
0006AC E60F                A  1059                AND     0FH
0006AE C630                A  1060                ADD     A,'0'
                           A  1061    
                           A  1062    ;            LD      C,02H
                           A  1063    ;            LD      E,A
0006B0 CD 4F 01            A  1064                CALL    UART0_serial_TX
                           A  1065    
0006B3 3A 51 09            A  1066                LD      A,(XPOS)
                           A  1067    
0006B6 E60F                A  1068    L3:         AND     0FH
0006B8 C630                A  1069                ADD     A,'0'
                           A  1070    
                           A  1071    ;            LD      C,02H
                           A  1072    ;            LD      E,A
0006BA CD 4F 01            A  1073                CALL    UART0_serial_TX
                           A  1074    
                           A  1075    ;            LD      C,02H
0006BD 3E48                A  1076                LD      a,'H'
0006BF CD 4F 01            A  1077                CALL    UART0_serial_TX
                           A  1078    
0006C2 C9                  A  1079                RET
                           A  1080    
0006C3                     A  1081    NEWLINE:
                           A  1082    
                           A  1083    ;            LD      C,02H
0006C3 3E0D                A  1084                LD      A,CR
0006C5 CD 4F 01            A  1085                CALL    UART0_serial_TX
                           A  1086    
                           A  1087    ;            LD      C,02H
0006C8 3E0A                A  1088                LD      A,LF
0006CA CD 4F 01            A  1089                CALL    UART0_serial_TX
                           A  1090    
0006CD C9                  A  1091                RET
                           A  1092    
0006CE 110000              A  1093    RAND16:     LD      DE,0
0006D1 7A                  A  1094                LD      A,D
0006D2 63                  A  1095                LD      H,E
0006D3 2EFD                A  1096                LD      L,253
0006D5 B7                  A  1097                OR      A
0006D6 ED52                A  1098                SBC     HL,DE
0006D8 DE00                A  1099                SBC     A,0
0006DA ED52                A  1100                SBC     HL,DE
0006DC 1600                A  1101                LD      D,0
0006DE 9A                  A  1102                SBC     A,D
0006DF 5F                  A  1103                LD      E,A
0006E0 ED52                A  1104                SBC     HL,DE
0006E2 30 01               A  1105                JR      NC,RAND
0006E4 23                  A  1106                INC     HL
0006E5 22 CF 06            A  1107    RAND:       LD      (RAND16+1),HL
0006E8 C9                  A  1108                RET
                           A  1109    
0006E9                     A  1110    DIV16:
0006E9 7C                  A  1111                LD      A,H         ; HL = HL % DE
0006EA 4D                  A  1112                LD      C,L
0006EB 210000              A  1113                LD      HL,0
0006EE 0610                A  1114                LD      B,16
                           A  1115    
0006F0 37                  A  1116    DL1:        SCF
0006F1 CB11                A  1117                RL      C
0006F3 17                  A  1118                RLA
0006F4 ED6A                A  1119                ADC     HL,HL
0006F6 ED52                A  1120                SBC     HL,DE
0006F8 30 02               A  1121                JR      NC,$+4
0006FA 19                  A  1122                ADD     HL,DE
0006FB 0D                  A  1123                DEC     C
0006FC 10 F2               A  1124                DJNZ    DL1
                           A  1125    
0006FE 57                  A  1126                LD      D,A         ; DE = HL / DE
0006FF 59                  A  1127                LD      E,C
000700 C9                  A  1128                RET
                           A  1129    
000701                     A  1130    show_string_de:
                           A  1131    ;        ld c, BDOS_Print_String = 9
000701 1A                  A  1132            ld      a,(de)
000702 FE24                A  1133            cp      '$'
000704 C8                  A  1134            ret     z
                           A  1135    ;        push    de
                           A  1136    ;        rst     10h
000705 CD 4F 01            A  1137    		call	UART0_serial_TX
                           A  1138    ;        pop     de
000708 13                  A  1139            inc     de
000709 18 F6               A  1140            jr      show_string_de
                           A  1141    
00070B                     A  1142    BOARD:
00070B 00000000            A  1143                DB     00, 00, 00, 00
00070F 00000000            A  1144                DB     00, 00, 00, 00
000713 00000000            A  1145                DB     00, 00, 00, 00
000717 00000000            A  1146                DB     00, 00, 00, 00
                           A  1147    
00071B 20202020 20202024   A  1148    SPACER:     DB     "       ", '$'
                           A  1149    
000723 3F07                A  1150    LABELPTR:   DW     LABELS
000725 4707                A  1151                DW     LABELS + 8
000727 4F07                A  1152                DW     LABELS + 16
000729 5707                A  1153                DW     LABELS + 24
00072B 5F07                A  1154                DW     LABELS + 32
00072D 6707                A  1155                DW     LABELS + 40
00072F 6F07                A  1156                DW     LABELS + 48
000731 7707                A  1157                DW     LABELS + 56
000733 7F07                A  1158                DW     LABELS + 64
000735 8707                A  1159                DW     LABELS + 72
000737 8F07                A  1160                DW     LABELS + 80
000739 9707                A  1161                DW     LABELS + 88
00073B 9F07                A  1162                DW     LABELS + 96
00073D A707                A  1163                DW     LABELS + 104
                           A  1164    
00073F 202020F9 20202024   A  1165    LABELS:     DB     "   ", 0F9H, "   ", EOS
000747 20202032 20202024   A  1166                DB     "   2   ", EOS
00074F 20202034 20202024   A  1167                DB     "   4   ", EOS
000757 20202038 20202024   A  1168                DB     "   8   ", EOS
00075F 20202031 36202024   A  1169                DB     "   16  ", EOS
000767 20202033 32202024   A  1170                DB     "   32  ", EOS
00076F 20202036 34202024   A  1171                DB     "   64  ", EOS
000777 20203132 38202024   A  1172                DB     "  128  ", EOS
00077F 20203235 36202024   A  1173                DB     "  256  ", EOS
000787 20203531 32202024   A  1174                DB     "  512  ", EOS
00078F 20313032 34202024   A  1175                DB     " 1024  ", EOS
000797 20323034 38202024   A  1176                DB     " 2048  ", EOS
00079F 20343039 36202024   A  1177                DB     " 4096  ", EOS
0007A7 20383139 32202024   A  1178                DB     " 8192  ", EOS
                           A  1179    
0007AF CB07                A  1180    COLORPTR:   DW     COLORS
0007B1 D407                A  1181                DW     COLORS + 9
0007B3 DD07                A  1182                DW     COLORS + 18
0007B5 E607                A  1183                DW     COLORS + 27
0007B7 EF07                A  1184                DW     COLORS + 36
0007B9 F807                A  1185                DW     COLORS + 45
0007BB 0108                A  1186                DW     COLORS + 54
0007BD 0A08                A  1187                DW     COLORS + 63
0007BF 1308                A  1188                DW     COLORS + 72
0007C1 1C08                A  1189                DW     COLORS + 81
0007C3 2508                A  1190                DW     COLORS + 90
0007C5 2E08                A  1191                DW     COLORS + 99
0007C7 3708                A  1192                DW     COLORS + 108
0007C9 4008                A  1193                DW     COLORS + 117
                           A  1194    
0007CB 1B5B3430 3B33376D   A  1195    COLORS:     DB     1BH, "[40;37m", EOS  ; 0
0007D3 24 
0007D4 1B5B3434 3B33376D   A  1196                DB     1BH, "[44;37m", EOS  ; 2
0007DC 24 
0007DD 1B5B3436 3B33376D   A  1197                DB     1BH, "[46;37m", EOS  ; 4
0007E5 24 
0007E6 1B5B3432 3B33376D   A  1198                DB     1BH, "[42;37m", EOS  ; 8
0007EE 24 
0007EF 1B5B3433 3B33306D   A  1199                DB     1BH, "[43;30m", EOS  ; 16
0007F7 24 
0007F8 1B5B3435 3B33376D   A  1200                DB     1BH, "[45;37m", EOS  ; 32
000800 24 
000801 1B5B3431 3B33376D   A  1201                DB     1BH, "[41;37m", EOS  ; 64
000809 24 
00080A 1B5B3437 3B33306D   A  1202                DB     1BH, "[47;30m", EOS  ; 128
000812 24 
000813 1B5B3434 3B33376D   A  1203                DB     1BH, "[44;37m", EOS  ; 256
00081B 24 
00081C 1B5B3436 3B33376D   A  1204                DB     1BH, "[46;37m", EOS  ; 512
000824 24 
000825 1B5B3432 3B33376D   A  1205                DB     1BH, "[42;37m", EOS  ; 1024
00082D 24 
00082E 1B5B3433 3B33306D   A  1206                DB     1BH, "[43;30m", EOS  ; 2048
000836 24 
000837 1B5B3435 3B33376D   A  1207                DB     1BH, "[45;37m", EOS  ; 4096
00083F 24 
000840 1B5B3431 3B33376D   A  1208                DB     1BH, "[41;37m", EOS  ; 8192
000848 24 
                           A  1209    
000849 0000                A  1210    POINTS:     DW     0000H
00084B 0000                A  1211                DW     0000H
00084D 0400                A  1212                DW     0004H
00084F 0800                A  1213                DW     0008H
000851 1600                A  1214                DW     0016H
000853 3200                A  1215                DW     0032H
000855 6400                A  1216                DW     0064H
000857 2801                A  1217                DW     0128H
000859 5602                A  1218                DW     0256H
00085B 1205                A  1219                DW     0512H
00085D 2410                A  1220                DW     1024H
00085F 4820                A  1221                DW     2048H
000861 9640                A  1222                DW     4096H
000863 9281                A  1223                DW     8192H
                           A  1224    
000865                     A  1225    INIT:
000865 1700C100            A  1226    	db	23,0,193,0	;turn off legacy mode so that mode 1 makes sense
000869 1600                A  1227    	db	22,0		;VDU 22 0 = set mode 0
00086B 1700FF              A  1228    	db	23,0,255	;VDU 23 0 0xFF = set terminal mode       
00086E 1B5B3F32 356C1B5B   A  1229    		DB     1BH, "[?25l", 1BH, "[2J", EOS
000876 324A24 
000879 7F7F1B5F 23512124   A  1230    TERM:      db		7fh,7fh,ESC,'_#Q!$'	 
                           A  1231    ;	DB     1BH, "[?25h"
000881 1B5B306D 24         A  1232    RESET:      DB     1BH, "[0m", EOS
                           A  1233    
000886 1B5B3238 4324       A  1234    ADVANCE:    DB     1BH, "[28C", EOS
                           A  1235    
00088C DC                  A  1236    TOPBORDER:  DB     0DCH
00088D DCDCDCDC DCDCDC     A  1237                DB     0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH
000894 DCDCDCDC DCDCDC     A  1238                DB     0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH
00089B DCDCDCDC DCDCDC     A  1239                DB     0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH
0008A2 DCDCDCDC DCDCDC     A  1240                DB     0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH, 0DCH
0008A9 DC24                A  1241                DB     0DCH, EOS
                           A  1242    
0008AB DF                  A  1243    BTMBORDER:  DB     0DFH
0008AC DFDFDFDF DFDFDF     A  1244                DB     0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH
0008B3 DFDFDFDF DFDFDF     A  1245                DB     0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH
0008BA DFDFDFDF DFDFDF     A  1246                DB     0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH
0008C1 DFDFDFDF DFDFDF     A  1247                DB     0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH, 0DFH
0008C8 DF24                A  1248                DB     0DFH, EOS
                           A  1249    
0008CA 1B5B306D            A  1250    MSG1:       DB     1BH, "[0m"
0008CE 20202020 20202020   A  1251                DB     "        w/a/s/d or q        "
0008D6 772F612F 732F6420 
0008DE 6F722071 20202020 
0008E6 20202020 
0008EA 24                  A  1252                DB     EOS
0008EB 1B5B306D            A  1253    MSG2:       DB     1BH, "[0m"
0008EF 20202020 20202020   A  1254                DB     "        QUIT? (y/n)         "
0008F7 51554954 3F202879 
0008FF 2F6E2920 20202020 
000907 20202020 
00090B 24                  A  1255                DB     EOS
00090C 1B5B306D            A  1256    MSG3:       DB     1BH, "[0m"
000910 20202020 20202020   A  1257                DB     "         GAME OVER!         "
000918 2047414D 45204F56 
000920 45522120 20202020 
000928 20202020 
00092C 070D0A24            A  1258                DB     BEL, CR, LF, EOS
000930 1B5B306D            A  1259    MSG4:       DB     1BH, "[0m"
000934 32303438 20202020   A  1260                DB     "2048                     pts"
00093C 20202020 20202020 
000944 20202020 20202020 
00094C 20707473 
000950 24                  A  1261                DB     EOS
                           A  1262    
                           A  1263    ; variables
                           A  1264    
000951 00                  A  1265    XPOS:       DB     0
000952 00                  A  1266    YPOS:       DB     0
000953 0000                A  1267    BOARDPTR:   DW     0
000955 00                  A  1268    MOVED:      DB     0
000956 00                  A  1269    RESULT:     DB     0
000957 00000000            A  1270    SCORE:      DB     00H, 00H, 00H, 00H
00095B 1B5B306D 20202020   A  1271    SCORESTR:   DB     1BH, "[0m        $"
000963 20202020 24 
                           A  1272    
                           A  1273                END
                           A  1274    


Errors: 0
Warnings: 0
Lines Assembled: 1629
